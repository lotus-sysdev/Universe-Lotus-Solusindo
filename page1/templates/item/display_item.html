{% extends 'base.html' %} {% load auth_extras %} {% block title %}Item Data
Table{% endblock %} {% block content %}
<style>
  .custom-dropdown {
    background-color: royalblue;
    color: white;
    border-color: royalblue;
  }
</style>
<h1>Item List</h1>
<table
  id="itemTable"
  class="table table-bordered table-striped w-100 table-responsive-lg"
>
  <div class="form-inline mb-2">
    <select id="columnFilter" class="form-control btn-info">
      <option value="">Select Column</option>
      <option value="0">Upload Type</option>
      <option value="1">Tanggal Input</option>
      <option value="2">Tanggal Pesan</option>
      <option value="3">Customer</option>
      <option value="4">PIC</option>
      <option value="5">SKU</option>
      <option value="6">Nama</option>
      <option value="7">Category</option>
      <option value="8">Catatan</option>
      <option value="9">Quantity</option>
      <option value="10">Price</option>
      <option value="13">Approved</option>
      <!-- Tambahkan opsi lain jika diperlukan -->
    </select>
    <input
      type="text"
      id="columnSearch"
      placeholder="Search in selected column"
      class="form-control m-1"
      style="width: 30%"
    />
    <button id="searchButton" class="btn btn-primary mr-1">Search</button>
    <button id="resetButtonCol" class="btn btn-secondary mr-2">Reset</button>
    <button id="filterDuplicatesButton" class="btn btn-warning">
      Check Duplicates
    </button>
    <button id="resetFilterDuplicatesBtn" class="btn btn-secondary ml-1">
      Reset
    </button>
  </div>

  <div class="form-inline mb-2">
    <label class="mr-2" for="startDate">Start Date:</label>
    <input
      type="date"
      id="startDate"
      class="form-control mr-1"
      style="width: 15%"
    />
    <label class="mr-2" for="endDate">End Date:</label>
    <input
      type="date"
      id="endDate"
      class="form-control mr-1"
      style="width: 15%"
    />
    <button id="filterButton" class="btn btn-primary">Apply</button>
    <select id="dateRange" class="form-control ml-2 btn-info">
      <option value="">Select Date Range</option>
      <option value="7">Last 7 days</option>
      <option value="30">Last 30 days</option>
      <option value="60">Last 60 days</option>
      <option value="90">Last 90 days</option>
      <option value="ytd">Current year to date</option>
      <option value="365">Last 1 year (365 days)</option>
      <option value="730">Last 2 years (730 days)</option>
    </select>
    <button id="resetButton" class="btn btn-secondary ml-1">Reset</button>
  </div>

  <thead class="thead-light">
    {% csrf_token %}
    <tr>
      <th>Upload Type</th>
      <th>Tanggal Input</th>
      <th>Tanggal Pesan</th>
      <th>Customer</th>
      <th>PIC</th>
      <th>SKU</th>
      <th>Nama</th>
      <th>Catatan</th>
      <th>Category</th>
      <th>Quantity</th>
      <th>Price</th>
      <th>Gambar</th>
      <th>Link</th>
      <th>Status (Approve)</th>
      <th>Edit/Delete</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<a href="/add_item">Add Item</a><br />

<script>
  var table;
  function initializeDataTable() {
    var isAdmin = "{{ request.user|has_group:'Admin' }}";
    table = new DataTable("#itemTable", {
      processing: true,
      serverSide: true,
      searching: false,
      ajax: {
        url: "{% url 'display_item' %}",
        type: "GET",
        data: function (d) {
          d.search_value = $("#columnSearch").val();
          d.column_filter = $("#columnFilter").val();
          d.start_date = $("#startDate").val();
          d.end_date = $("#endDate").val();
          console.log("Sending Params:", d);
        },
        dataSrc: function (json) {
          return json.data;
        },
      },
      select: { style: "multi" },
      // Sesuaikan columnDefs jika diperlukan (misal: formatting price atau gambar)
      columnDefs: [
        {
          targets: 10,
          render: function (data, type) {
            if (type === "display") {
              if (data.startsWith("IDR")) {
                // Replace commas with periods and periods with commas
                data = data
                  .replace(/,/g, "#")
                  .replace(/\./g, ",")
                  .replace(/#/g, ".");
                data = data.substr(0, data.indexOf(","));
                data = data.substr(0, 3) + " " + data.substr(3);
                return data;
              } else if (data.startsWith("$")) {
                data = data.replace("$", "USD");
                data = data.substr(0, 3) + " " + data.substr(3);
                return data;
              } else {
                // Add a space after the first three characters
                return data.substr(0, 3) + " " + data.substr(3);
              }
            }
            return data;
          },
        },
        {
          targets: [4],
          render: function (data, type) {
            if (type === "display" && data && data.includes("-")) {
              return data.split("-")[1].trim();
            }
            return data;
          },
        },
        {
          targets: 13,
          render: function (data, type) {
            if (type === "display") {
              return data === "Yes" ? "Yes" : "No";
            }
            return data;
          },
        },
      ],
      columns: [
        { visible: false },
        { visible: false },
        null,
        null,
        null,
        { visible: false },
        { visible: true, width: "15%" },
        { visible: true, width: "20%" },
        null,
        null,
        { visible: true, width: "9%" },
        null,
        null,
        { visible: true, width: "9%" },
        null,
      ],
      createdRow: function (row, data) {
        if (data[13] === "Yes") {
          $(row).css("background-color", "#ccffc7");
        }
      },
      lengthMenu: [
        [10, 25, 50, 100, -1],
        [10, 25, 50, 100, "All"],
      ],
      dom: "Bfrtip",
      buttons: [
        {
          text: "PDF",
          extend: "print",
          className: "btn-primary",
          exportOptions: { columns: ":visible", stripHtml: false },
        },
        {
          text: "Upload Excel",
          className: "btn-secondary",
          action: function () {
            window.location.href = "/upload_excel";
          },
        },
        {
          text: "Delete Rows",
          className: "btn-danger",
          action: deleteSelectedRows,
        },
        {
          extend: "copy",
          text: "Copy",
          className: "btn-warning",
          header: false,
          exportOptions: { columns: [6, 10] },
          title: null,
        },
        {
          text: "{% if request.user|has_group:'Admin' %} Approve {% endif %}",
          className: "btn-success",
          action: approveRows,
          init: function (api, node) {
            if (isAdmin === "False") {
              $(node).addClass("d-none");
            }
          },
        },
        { extend: "colvis", className: "btn-info" },
      ],
    });
  }

  function deleteSelectedRows() {
    if (!table) {
      console.error("Table is not initialized.");
      return;
    }
    var selectedIDs = table
      .rows(".selected")
      .data()
      .toArray()
      .map(function (row) {
        return row[5];
      });
    if (selectedIDs.length === 0) {
      alert("Please select at least one row to delete.");
      return;
    }
    if (confirm("Are you sure you want to delete the selected rows?")) {
      var csrfToken = document.getElementsByName("csrfmiddlewaretoken")[0]
        .value;
      $.ajax({
        url: '{% url "delete_selected_rows_item" %}',
        type: "POST",
        data: { selected_ids: selectedIDs, csrfmiddlewaretoken: csrfToken },
        dataType: "json",
        success: function (response) {
          if (response.success) {
            alert("Selected rows deleted successfully.");
            location.reload();
          } else {
            alert("Error deleting selected rows: " + response.error);
          }
        },
        error: function (xhr, status, error) {
          alert("Error deleting selected rows: " + error);
        },
      });
    }
  }

  function approveRows() {
    if (!table) {
      console.error("Table is not initialized.");
      return;
    }
    var selectedIDs = table
      .rows(".selected")
      .data()
      .toArray()
      .map(function (row) {
        return row[5];
      });
    if (selectedIDs.length === 0) {
      alert("Please select at least one row to approve.");
      return;
    }
    if (confirm("Are you sure you want to approve the selected rows?")) {
      var csrfToken = document.getElementsByName("csrfmiddlewaretoken")[0]
        .value;
      $.ajax({
        url: '{% url "approve_selected_rows" %}',
        type: "POST",
        data: { selected_ids: selectedIDs, csrfmiddlewaretoken: csrfToken },
        dataType: "json",
        success: function (response) {
          if (response.success) {
            alert("Selected rows approved successfully.");
            location.reload();
          } else {
            alert("Error approving selected rows: " + response.error);
          }
        },
        error: function (xhr, status, error) {
          alert("Error approving selected rows: " + error);
        },
      });
    }
  }

  $(document).ready(function () {
    initializeDataTable();

    $("#startDate").val("");
    $("#endDate").val("");

    $("#searchButton")
      .off("click")
      .on("click", function () {
        console.log("Search clicked. Value:", $("#columnSearch").val());
        table.ajax.reload();
      });

    $("#columnSearch").on("keypress", function (e) {
      if (e.which === 13) {
        table.ajax.reload();
      }
    });

    $("#resetButtonCol")
      .off("click")
      .on("click", function () {
        $("#columnSearch").val("");
        table.ajax.reload();
      });

    $("#filterButton")
      .off("click")
      .on("click", function () {
        var startDate = $("#startDate").val();
        var endDate = $("#endDate").val();
        $("#startDate").val(startDate);
        $("#endDate").val(endDate);
        table.ajax.reload();
      });

    $("#resetButton")
      .off("click")
      .on("click", function () {
        $("#startDate").val("");
        $("#endDate").val("");
        $("#dateRange").val("");
        $("#columnSearch").val("");
        table.ajax.reload();
      });

    $("#dateRange")
      .off("change")
      .on("change", function () {
        var dateRange = $(this).val();
        var startDate = "";
        var endDate = "";
        if (dateRange === "7") {
          endDate = formatDate(new Date());
          startDate = formatDate(
            new Date(new Date().setDate(new Date().getDate() - 6))
          );
        } else if (dateRange === "30") {
          endDate = formatDate(new Date());
          startDate = formatDate(
            new Date(new Date().setDate(new Date().getDate() - 29))
          );
        } else if (dateRange === "60") {
          endDate = formatDate(new Date());
          startDate = formatDate(
            new Date(new Date().setDate(new Date().getDate() - 59))
          );
        } else if (dateRange === "90") {
          endDate = formatDate(new Date());
          startDate = formatDate(
            new Date(new Date().setDate(new Date().getDate() - 89))
          );
        } else if (dateRange === "365") {
          endDate = formatDate(new Date());
          startDate = formatDate(
            new Date(new Date().setDate(new Date().getDate() - 364))
          );
        } else if (dateRange === "730") {
          endDate = formatDate(new Date());
          startDate = formatDate(
            new Date(new Date().setDate(new Date().getDate() - 729))
          );
        } else if (dateRange === "ytd") {
          endDate = formatDate(new Date());
          startDate = formatDate(new Date(new Date().getFullYear(), 0, 1));
        }
        $("#startDate").val(startDate);
        $("#endDate").val(endDate);
        table.ajax.reload();
      });

    function formatDate(date) {
      var year = date.getFullYear();
      var month = ("0" + (date.getMonth() + 1)).slice(-2);
      var day = ("0" + date.getDate()).slice(-2);
      return year + "-" + month + "-" + day;
    }

    function filterByDateRange(startDate, endDate) {
      $("#startDate").val(startDate);
      $("#endDate").val(endDate);
      table.ajax.reload();
    }
  });
</script>
{% endblock %}
